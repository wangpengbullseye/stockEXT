# 本地数据源使用说明

## 概述

本项目已经修改为支持从本地文件系统读取股票数据，而不是从互联网获取。这样可以提供更稳定、更快速的数据访问，并且可以使用自己的历史数据。

## 数据源配置

### 1. 数据目录结构

请按照以下结构组织您的股票数据：

```
E:\work\stock\data\
├── 2022\
│   ├── SH.600000.csv
│   ├── SH.600001.csv
│   ├── SZ.000001.csv
│   ├── SZ.000002.csv
│   └── ...
├── 2023\
│   ├── SH.600000.csv
│   ├── SH.600001.csv
│   ├── SZ.000001.csv
│   ├── SZ.000002.csv
│   └── ...
└── 2024\
    ├── SH.600000.csv
    ├── SH.600001.csv
    ├── SZ.000001.csv
    ├── SZ.000002.csv
    └── ...
```

### 2. 文件命名规则

- 上海股票：`SH.{股票代码}.csv`，例如：`SH.600000.csv`
- 深圳股票：`SZ.{股票代码}.csv`，例如：`SZ.000001.csv`

### 3. CSV文件格式

每个CSV文件应包含以下列（按顺序）：

```csv
日期,代码,开盘价,最高价,最低价,收盘价,成交量（手）,成交额（元）
2024-01-02,600000,10.00,10.50,9.80,10.20,1000000,10200000
2024-01-03,600000,10.20,10.60,10.00,10.40,1100000,11440000
2024-01-04,600000,10.40,10.80,10.20,10.60,1200000,12720000
...
```

**重要说明：**
- 日期格式：`YYYY-MM-DD`
- 价格数据：浮点数
- 成交量：整数（手）
- 成交额：整数（元）

## 配置修改

### 1. 修改数据路径

编辑 `config.py` 文件中的 `LOCAL_DATA_PATH` 变量：

```python
# 本地数据源配置
# 用户可以修改这个路径指向自己的股票数据目录
LOCAL_DATA_PATH = r'E:\work\stock\data'
```

将路径修改为您的实际数据目录。

### 2. 支持的股票代码格式

系统支持多种股票代码格式：

- `sh600000` - 上海股票（带前缀）
- `sz000001` - 深圳股票（带前缀）
- `600000.XSHG` - 上海股票（聚宽格式）
- `000001.XSHE` - 深圳股票（聚宽格式）
- `600000` - 纯数字格式（6开头默认为上海）
- `000001` - 纯数字格式（其他默认为深圳）

## 使用方法

### 1. Web界面

启动Web应用：

```bash
python app.py
```

然后在浏览器中访问 `http://127.0.0.1:5000`，输入股票代码即可查看K线图。

### 2. API接口

直接调用API获取数据：

```bash
curl "http://127.0.0.1:5000/api/kline?code=sh600000&period=D&limit=10"
```

参数说明：
- `code`: 股票代码
- `period`: 周期（D=日线，W=周线，M=月线，1/5/15/30/60=分钟线）
- `limit`: 返回的K线数量
- `end_date`: 结束日期（可选）
- `start_date`: 开始日期（可选）

### 3. Python代码调用

```python
import Ashare

# 获取股票数据
df = Ashare.get_price('sh600000', frequency='1d', count=10)
print(df)
```

### 4. MCP服务

如果使用MCP服务，可以通过以下方式调用：

```python
# 使用MCP工具获取股票数据
result = await get_price(
    code='sh600000',
    frequency='1d',
    count=10
)
```

## 数据回退机制

系统采用了智能的数据回退机制：

1. **优先使用本地数据**：首先尝试从本地文件系统读取数据
2. **网络数据备用**：如果本地数据不存在或读取失败，自动切换到网络数据源
3. **错误处理**：提供详细的错误信息和日志

## 测试功能

### 1. 运行配置测试

```bash
python config.py
```

这将显示当前的配置信息和支持的股票代码格式。

### 2. 运行数据测试

```bash
python test_local.py
```

这将测试本地数据读取功能。

## 注意事项

1. **数据完整性**：确保CSV文件格式正确，缺少列或格式错误会导致读取失败
2. **文件编码**：CSV文件应使用UTF-8编码
3. **年份目录**：系统会根据查询的日期范围自动选择对应年份的目录
4. **性能优化**：本地数据读取比网络获取快得多，特别适合大量数据查询

## 故障排除

### 1. 数据文件不存在

如果看到类似错误：
```
读取本地数据失败: 数据文件不存在: E:\work\stock\data\2024\SH.600000.csv
```

请检查：
- 数据目录路径是否正确
- 年份目录是否存在
- 股票代码对应的CSV文件是否存在

### 2. CSV格式错误

如果数据读取失败，请检查：
- CSV文件是否包含正确的列标题
- 数据格式是否符合要求
- 文件编码是否为UTF-8

### 3. 权限问题

确保程序对数据目录有读取权限。

## 示例数据

项目包含了测试数据文件 `test_data/2024/SH.600000.csv`，您可以参考其格式来准备自己的数据文件。
